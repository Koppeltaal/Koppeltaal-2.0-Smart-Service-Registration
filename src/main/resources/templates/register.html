<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragment/head :: head"></head>
<body>
<nav th:replace="fragment/header :: header(selected='register')"></nav>
<div class="container">
  <div class="row new-registry">
    <div class="col s12">
      <div class="card ">
        <form method="post">
          <div class="card-content amber-text">
            <div class="row">
            <span class="card-title">Nieuwe aanvraag SMART Backend Service</span>
              <div class="row col s12" th:if="${error != null}" >
                <h6 class="red-text" th:text="${error.message}"></h6>
              </div>
              <div class="input-field col s6">
                <i class="material-icons prefix">contact_mail</i>
                <input th:if="${error == null}" placeholder="JWKS endpoint" id="jwks_endpoint" name="jwksEndpoint" type="url" class="validate">
                <input th:if="${error != null}" placeholder="JWKS endpoint" id="jwks_endpoint" name="jwksEndpoint" type="url" class="validate" th:value="${error.endpoint}">
                <label for="jwks_endpoint">JWKS Endpoint</label>
                <span class="helper-text"></span>
              </div>
            </div>
          </div>
          <div class="card-action">
            <button disabled id="submit-button" class="btn waves-effect waves-light amber darken-1" type="submit" name="action">Submit
              <i class="material-icons right">send</i>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
</body>

<!--JavaScript at end of body for optimized loading-->
<script type="text/javascript" src="js/materialize.min.js"></script>
<script th:inline="javascript">
  (function()  {

    const updateSaveButton = function(event) {
      const input = event.target;
      const value = input.value;

      let isHttps = false;
      let isJwks = false;
      let isUnique = false;

      // Set HTML5 validity - we must have an HTTPS endpoint
      try {
        const url = new URL(value);
        isHttps = url.protocol === "https:";
        isJwks = value.endsWith("/.well-known/jwks.json");

        isUnique = ![[${registeredEndpoints}]].includes(value);
      } catch (_) {}

      const saveButton = document.getElementById('submit-button');

      if(isHttps && isJwks && isUnique) {
        saveButton.removeAttribute("disabled");
        input.setCustomValidity("");
      } else {
        saveButton.setAttribute("disabled", "true");
        if(!isHttps) input.setCustomValidity("HTTPS endpoint vereist");
        else if(!isJwks) input.setCustomValidity("Eindigt niet met /.well-known/jwks.json");
        else if(!isUnique) input.setCustomValidity("Endpoint niet meer beschikbaar");
      }
      input.reportValidity();
    };

    const jwksInput = document.getElementById('jwks_endpoint');
    jwksInput.addEventListener('keyup', updateSaveButton, true);
  })();
</script>

</html>